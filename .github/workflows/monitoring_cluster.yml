name: Deploy and Monitor K3s Cluster

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  deploy-k3s:
    runs-on: ubuntu-latest
    steps:
      - name: Install K3s
        run: |
          curl -sfL https://get.k3s.io | sh -
          sudo chmod 644 /etc/rancher/k3s/k3s.yaml

      - name: Prepare kubeconfig
        run: |
          mkdir -p ~/.kube
          sudo cat /etc/rancher/k3s/k3s.yaml > ~/.kube/config
          sed -i 's/127.0.0.1/localhost/g' ~/.kube/config

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Deploy test application
        run: |
          kubectl create deployment nginx --image=nginx:alpine --replicas=2
          kubectl expose deployment nginx --port=80 --type=ClusterIP

      - name: 1-minute health check loop
        run: |
          echo "Starting 1-minute health monitoring (6 checks, every 10s)..."
          for i in {1..6}; do
            echo "[$(date)] Check $i/6"
            kubectl get nodes
            kubectl get pods -l app=nginx
            SVC_IP=$(kubectl get svc nginx -o jsonpath='{.spec.clusterIP}')
            if [ -n "$SVC_IP" ] && [ "$SVC_IP" != "<none>" ]; then
              echo "Testing service connectivity via kubectl port-forward (background)..."
              kubectl port-forward svc/nginx 8080:80 --address 0.0.0.0 2>/dev/null &
              PF_PID=$!
              sleep 2
              if curl -s http://localhost:8080 --max-time 5 | grep -q "Welcome to nginx"; then
                echo "✅ HTTP check passed"
              else
                echo "❌ HTTP check failed"
              fi
              kill $PF_PID 2>/dev/null || true
            else
              echo "⚠️ Service IP not ready"
            fi
            if [ $i -lt 6 ]; then sleep 10; fi
          done
          echo "Health check loop completed."

      - name: Upload final kubeconfig (for demo)
        uses: actions/upload-artifact@v4
        with:
          name: kubeconfig
          path: /home/runner/.kube/config
          retention-days: 1
